<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Table Cover Mockup Editor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Montserrat:wght@400;700&family=Oswald:wght@400;700&family=Roboto:wght@400;700&family=Poppins:wght@400;700&family=Inter:wght@400;700&family=Merriweather:wght@400;700&family=Noto+Sans:wght@400;700&family=Playfair+Display:wght@400;700&family=Ubuntu:wght@400;700&family=Source+Sans+Pro:wght@400;700&display=swap" rel="stylesheet">    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        :root {
            --brand-primary: #F1B241;
            --brand-secondary-dark: #1D1D1D;
            --brand-secondary-light: #EDE8E7;
            --brand-white: #FFFFFF;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--brand-white);
            color: var(--brand-secondary-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
        }

        h1 {
            color: var(--brand-secondary-dark);
            margin-bottom: 20px;
        }

        canvas {
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .controls-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        /* New Contextual Controls Bar */
        #contextual-controls {
            display: none; /* Hidden by default */
            align-items: center;
            gap: 20px;
            padding: 10px 15px;
            background-color: var(--brand-white);
            border: 1px solid #eee;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        #contextual-controls.visible {
            display: flex;
        }
        
        .context-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .context-group label {
            font-size: 14px;
            font-weight: 500;
        }
        
        #opacity-slider {
            width: 120px;
        }
        
        .layer-btn {
            background: none;
            border: none;
            padding: 4px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }
        
        .layer-btn:hover {
            background-color: var(--brand-secondary-light);
        }
        
        .layer-btn img {
            width: 22px;
            height: 22px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap; /* Added for better responsiveness */
            justify-content: center;
            align-items: stretch;  
            gap: 15px;
            padding: 12px;
            background-color: var(--brand-white);
            border: 1px solid #eee;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .modern-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 15px;
            background-color: var(--brand-secondary-light);
            border: 1px solid var(--brand-secondary-light);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--brand-secondary-dark);
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .modern-btn:hover {
            background-color: #e2e0df;
            border-color: #c9c7c6;
        }
        
        .modern-btn img { width: 20px; height: 20px; }
        
        .primary-action-btn {
            background-color: var(--brand-primary);
            color: var(--brand-secondary-dark);
            font-weight: 600;
            padding: 12px 30px;
            border-color: var(--brand-primary);
        }
        
        .primary-action-btn:hover {
            background-color: #d19a36;
            border-color: #d19a36;
        }
        
        #color-swatch {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--brand-white);
            box-shadow: 0 0 0 1px #ccc;  
        }

        .hidden-inputs { display: none; }
        
        /* --- START: Split Button & Dropdown Styles --- */
        .split-btn-container {
            display: flex;
            position: relative; /* For dropdown positioning */
        }
        
        #color-btn-main {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 15px;
            background-color: var(--brand-secondary-light);
            border: 1px solid var(--brand-secondary-light);
            border-radius: 8px 0 0 8px; /* Rounded left corners */
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--brand-secondary-dark);
            transition: all 0.2s ease;
            white-space: nowrap;
            border-right: 1px solid #dcdad9; /* Separator line */
        }
        
        #color-btn-dropdown {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 8px;
            background-color: var(--brand-secondary-light);
            border: 1px solid var(--brand-secondary-light);
            border-radius: 0 8px 8px 0; /* Rounded right corners */
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--brand-secondary-dark);
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        #color-btn-main:hover, #color-btn-dropdown:hover {
            background-color: #e2e0df;
            border-color: #c9c7c6;
        }
        
        #color-dropdown-menu {
            display: none; /* Hidden by default */
            position: absolute;
            top: 100%; /* Position below the button */
            left: 0;
            z-index: 1001;
            background-color: var(--brand-white);
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            margin-top: 5px;
        }

        #color-dropdown-menu button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 10px 15px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            color: var(--brand-secondary-dark);
        }

        #color-dropdown-menu button:hover {
            background-color: var(--brand-secondary-light);
        }
        
        #color-dropdown-menu button:first-child { border-radius: 8px 8px 0 0; }
        #color-dropdown-menu button:last-child { border-radius: 0 0 8px 8px; }
        #color-dropdown-menu button:not(:last-child) { border-bottom: 1px solid #eee; }
        
        /* --- END: Split Button & Dropdown Styles --- */


        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(29, 29, 29, 0.6); display: flex; align-items: center;
            justify-content: center; z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }

        .modal-overlay.visible { opacity: 1; visibility: visible; }

        .modal-popup {
            background: var(--brand-white); padding: 25px; border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); width: 90%;
            max-width: 500px; /* Increased max-width for Pantone grid */
            color: var(--brand-secondary-dark);
        }
        
        .modal-popup h2 { margin-top: 0; margin-bottom: 20px; }
        .modal-popup input[type="text"] {
            width: calc(100% - 24px); padding: 12px; border: 1px solid #ccc;
            border-radius: 8px; font-size: 16px; margin-bottom: 20px;
        }
        .modal-popup input[type="text"]:focus { outline: none; border-color: var(--brand-primary); }

        /* Style the new controls inside the modal */
        .modal-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            gap: 15px;
        }
        .modal-control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .modal-control-group label { font-size: 14px; font-weight: 500; }
        .modal-control-group select, .modal-control-group input[type="color"] {
            border-radius: 8px;
            border: 1px solid #ccc;
            padding: 5px;
            font-size: 14px;
        }
        .modal-control-group input[type="color"] { width: 30px; height: 30px; padding: 2px; }

        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; }
        .modal-btn {
            padding: 10px 20px; border-radius: 8px; border: none;
            cursor: pointer; font-size: 14px; font-weight: 600;
            transition: background-color 0.2s ease;
        }
        .modal-confirm-btn { background-color: var(--brand-primary); color: var(--brand-secondary-dark); }
        .modal-confirm-btn:hover { background-color: #d19a36; }
        .modal-cancel-btn { background-color: var(--brand-secondary-light); color: var(--brand-secondary-dark); }
        .modal-cancel-btn:hover { background-color: #e2e0df; }
        
        /* --- START: Pantone Modal Styles --- */
        #pantone-search {
            width: 100%;
            box-sizing: border-box; /* Ensures padding doesn't affect width */
            margin-bottom: 15px;
        }

        #pantone-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 8px;
        }
        
        .pantone-card {
            position: relative;
            aspect-ratio: 1 / 1; 
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.1);
            transition: transform 0.1s ease;
            overflow: hidden; 
        }
        
        .pantone-card:hover {
            transform: scale(1.05);
            border-color: rgba(0,0,0,0.5);
        }

        .pantone-swatch-bg {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%;
        }

        .pantone-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(2px); 
            color: var(--brand-secondary-dark);
            font-size: 9px; 
            font-weight: 600;
            padding: 4px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            box-sizing: border-box;
            border-top: 1px solid rgba(0,0,0,0.05);
        }
        
        #pantone-close-btn {
            margin-top: 20px;
        }
        /* --- END: Pantone Modal Styles --- */

        /* --- START: New Button & Disclaimer Styles --- */
        .download-wrapper {
            display: flex; /* Make buttons side-by-side */
            gap: 15px; /* Add space between buttons */
            justify-content: center; /* Center the buttons */
        }

        .disclaimer-text {
            font-size: 12px;
            color: #6c757d; /* Muted text color */
            text-align: center;
            max-width: 450px; /* Constrain width */
            margin-top: 10px; /* Space from buttons */
        }
        /* --- END: New Button & Disclaimer Styles --- */
    </style>
</head>
<body>

    <canvas id="editor-canvas" width="800" height="500"></canvas>

    <div class="controls-wrapper">
    
        <div id="contextual-controls">
            <div class="context-group">
                <label for="opacity-slider">Opacity:</label>
                <input type="range" id="opacity-slider" min="0" max="100" value="100">
            </div>
            <div class="context-group">
                <label>Layers:</label>
                <button id="layer-front-btn" class="layer-btn" title="Bring to Front">
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' fill='%231D1D1D' viewBox='0 0 256 256'%3E%3Cpath d='M216,96H160V40a8,8,0,0,0-8-8H40a8,8,0,0,0-8,8V152a8,8,0,0,0,8,8h56v56a8,8,0,0,0,8,8H216a8,8,0,0,0,8-8V104A8,8,0,0,0,216,96ZM160,152h-8V96h8Zm48,48H168V160a8,8,0,0,0-8-8H104V152a8,8,0,0,0,8,8h40v32Zm0-56H168v-8h48Z'%3E%3C/path%3E%3C/svg%3E" alt="Bring to Front">
                </button>
                <button id="layer-forward-btn" class="layer-btn" title="Bring Forward">
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' fill='%231D1D1D' viewBox='0 0 256 256'%3E%3Cpath d='M216,96H160V40a8,8,0,0,0-8-8H40a8,8,0,0,0-8,8V152a8,8,0,0,0,8,8h56v56a8,8,0,0,0,8,8H216a8,8,0,0,0,8-8V104A8,8,0,0,0,216,96ZM96,152H48V48h96v40H96v64Zm112,48H168V160a8,8,0,0,0-8-8H104v-8h48a8,8,0,0,0,8-8V96h48v96Z'%3E%3C/path%3E%3C/svg%3E" alt="Bring Forward">
                </button>
                <button id="layer-backward-btn" class="layer-btn" title="Send Backward">
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' fill='%231D1D1D' viewBox='0 0 256 256'%3E%3Cpath d='M216,104a8,8,0,0,0-8,8V216H104a8,8,0,0,0-8,8H40a8,8,0,0,0-8-8V104a8,8,0,0,0-8-8H96V40a8,8,0,0,1,8-8H216a8,8,0,0,1,8,8v56H160a8,8,0,0,0-8,8Zm-8-56H112v88a8,8,0,0,0,8,8h40V104a8,8,0,0,0-8-8H112V48Zm0,160V160H104v48a8,8,0,0,0,8,8h88V208Z'%3E%3C/path%3E%3C/svg%3E" alt="Send Backward">
                </button>
                <button id="layer-back-btn" class="layer-btn" title="Send to Back">
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' fill='%231D1D1D' viewBox='0 0 256 256'%3E%3Cpath d='M216,32H104a8,8,0,0,0-8,8V96H40a8,8,0,0,0-8,8V216a8,8,0,0,0,8,8H152a8,8,0,0,0,8-8V160h56a8,8,0,0,0,8-8V40A8,8,0,0,0,216,32ZM152,216H48V112h48v40a8,8,0,0,0,8,8h48Zm56-56H160a8,8,0,0,0-8,8v40H112V104a8,8,0,0,0-8-8H48V48h96V96h8v32h48Z'%3E%3C/path%3E%3C/svg%3E" alt="Send to Back">
                </button>
            </div>
        </div>
    
        <div class="controls">
            <button id="upload-btn" class="modern-btn">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' fill='%23495057' viewBox='0 0 256 256'%3E%3Cpath d='M216,40H40A16,16,0,0,0,24,56V200a16,16,0,0,0,16,16H216a16,16,0,0,0,16-16V56A16,16,0,0,0,216,40Zm0,16V158.75l-42.06-42.07a16,16,0,0,0-22.62,0L136,132,93.66,89.66a16,16,0,0,0-22.62,0L40,120.75V56H216Zm-29.66,122.34a16,16,0,0,0-22.62-22.62L136,183.25l-11.59-11.59a16,16,0,0,0-22.62,0L40,200H71.25l22.41-22.4a16,16,0,0,0,22.62,0L152,189.25l50.34-50.34a16,16,0,0,0-22.62-22.62L164,131.59,134.34,101.93a16,16,0,0,0-22.62,22.62L144,156.75V200h43.25l28.41-28.4a16,16,0,0,0,0-22.62ZM88,104a12,12,0,1,1-12-12A12,12,0,0,1,88,104Z'%3E%3C/path%3E%3C/svg%3E" alt="Image Icon">
                <span>Upload Image</span>
            </button>
            <button id="add-text-btn" class="modern-btn">
                 <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' fill='%23495057' viewBox='0 0 256 256'%3E%3Cpath d='M216,40H40A16,16,0,0,0,24,56V200a16,16,0,0,0,16,16H216a16,16,0,0,0,16-16V56A16,16,0,0,0,216,40Zm0,160H40V56H216V200ZM176,104a8,8,0,0,1-8,8H136v40a8,8,0,0,1-16,0V112H88a8,8,0,0,1,0-16h80a8,8,0,0,1,8,8Z'%3E%3C/path%3E%3C/svg%3E" alt="Add Text Icon">
                <span>Add Text</span>
            </button>
            
            <div class="split-btn-container">
                <button id="color-btn-main">
                    <div id="color-swatch" style="background-color: #ffffff;"></div>
                    <span>Tablecloth Color</span>
                </button>
                <button id="color-btn-dropdown">
                    <span>▼</span>
                </button>
                <div id="color-dropdown-menu">
                    <button id="dropdown-item-custom">Custom Color (RGB/HEX)</button>
                    <button id="dropdown-item-pantone">Pantone® Color Library</button>
                </div>
            </div>
        </div>
        
        <div class="download-wrapper">
             <button id="download-btn" class="modern-btn primary-action-btn">Download Mockup</button>
             <button id="add-to-cart-btn" class="modern-btn primary-action-btn">Add to Cart</button>
        </div>
        <p class="disclaimer-text">For complex artwork with multiple layers or patterns - please submit a mockup request and our design team will send it within 24 hours </p>
        </div>
    <div class="hidden-inputs">
        <input type="file" id="logo-upload" accept="image/png, image/jpeg, image/svg+xml">
        <input type="color" id="color-picker" value="#ffffff">
    </div>

    <div id="text-modal" class="modal-overlay">
        <div class="modal-popup">
            <h2>Add Custom Text</h2>
            <input type="text" id="modal-text-input" placeholder="Enter your text...">
            
            <div class="modal-controls">
                <div class="modal-control-group">
                    <label for="modal-font-family">Font:</label>
                   <select id="modal-font-family">
                        <option>Arial</option>
                        <option>Lato</option>
                        <option>Montserrat</option>
                        <option>Oswald</option>
                        <option>Roboto</option>
                        <option>Poppins</option>
                        <option>Inter</option>
                        <option>Merriweather</option>
                        <option>Noto Sans</option>
                        <option>Playfair Display</option>
                        <option>Ubuntu</option>
                        <option>Source Sans Pro</option>
                    </select>
                </div>
                <div class="modal-control-group">
                    <label for="modal-text-color">Color:</label>
                    <input type="color" id="modal-text-color" value="#1D1D1D">
                </div>
            </div>

            <div class="modal-buttons">
                <button id="modal-cancel-btn" class="modal-btn modal-cancel-btn">Cancel</button>
                <button id="modal-confirm-btn" class="modal-btn modal-confirm-btn">Add Text</button>
            </div>
        </div>
    </div>

    <div id="pantone-modal" class="modal-overlay">
        <div class="modal-popup">
            <h2>Pantone Colors</h2>
            <input type="text" id="pantone-search" placeholder="Search by name or code (e.g., 186 PC)">
            <div id="pantone-grid">
                </div>
            <div class="modal-buttons">
                <button id="pantone-close-btn" class="modal-btn modal-cancel-btn">Close</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const canvas = new fabric.Canvas('editor-canvas', {
            preserveObjectStacking: true
        });

        // --- START: Alignment & Clip Path Logic ---
        const targetArea = { left: 180, top: 230, width: 450, height: 120 };
        
        const clipRect = new fabric.Rect({
            left: targetArea.left,
            top: targetArea.top,
            width: targetArea.width,
            height: targetArea.height,
            absolutePositioned: true 
        });
        
        const centerH = targetArea.left + (targetArea.width / 2);
        const centerV = targetArea.top + (targetArea.height / 2);
        const snapThreshold = 20; 

        const guideLineV = new fabric.Line([ centerH, targetArea.top - 20, centerH, targetArea.top + targetArea.height + 20 ], {
            stroke: 'red',
            strokeWidth: 1,
            selectable: false,
            evented: false,
            visible: false
        });
        const guideLineH = new fabric.Line([ targetArea.left - 20, centerV, targetArea.left + targetArea.width + 20 ], {
            stroke: 'red',
            strokeWidth: 1,
            selectable: false,
            evented: false,
            visible: false
        });
        
        canvas.add(guideLineV, guideLineH);

        canvas.on('object:moving', (e) => {
            const obj = e.target;
            
            if (Math.abs(obj.left - centerH) < snapThreshold) {
                obj.set({ left: centerH });
                guideLineV.set({ visible: true });
            } else {
                guideLineV.set({ visible: false });
            }

            if (Math.abs(obj.top - centerV) < snapThreshold) {
                obj.set({ top: centerV });
                guideLineH.set({ visible: true });
            } else {
                guideLineH.set({ visible: false });
            }
        });

        canvas.on('object:modified', () => {
            guideLineV.set({ visible: false });
            guideLineH.set({ visible: false });
            canvas.renderAll();
        });
        // --- END: Alignment & Clip Path Logic ---


        // --- DELETE FUNCTIONALITY ---
        const deleteIcon = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Ccircle cx='12' cy='12' r='11' fill='%23E34F4F' stroke='white' stroke-width='1.5'/%3E%3Cpath d='M8 8 L16 16 M16 8 L8 16' stroke='white' stroke-width='2.5' stroke-linecap='round'/%3E%3C/svg%3E";
        const deleteImg = document.createElement('img');
        deleteImg.src = deleteIcon;

        function renderIcon(ctx, left, top, styleOverride, fabricObject) {
            const size = this.cornerSize;
            ctx.save();
            ctx.translate(left, top);
            ctx.rotate(fabric.util.degreesToRadians(fabricObject.angle));
            ctx.drawImage(deleteImg, -size / 2, -size / 2, size, size);
            ctx.restore();
        }

        function deleteObject(eventData, transform) {
            const canvas = transform.target.canvas;
            canvas.remove(transform.target);
            canvas.requestRenderAll();
            return true;
        }

        function addDeleteControl(obj) {
            obj.controls.deleteControl = new fabric.Control({
                x: 0.5, y: -0.5, offsetY: -16, offsetX: 16, cursorStyle: 'pointer',
                mouseUpHandler: deleteObject,
                render: renderIcon,
                cornerSize: 24
            });
        }
        
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' || e.key === 'Delete') {
                if (document.activeElement.tagName === 'INPUT') return;
                const activeObjects = canvas.getActiveObjects();
                if (activeObjects.length > 0) {
                    activeObjects.forEach(obj => canvas.remove(obj));
                    canvas.discardActiveObject().requestRenderAll();
                }
            }
        });

        // --- CANVAS SETUP ---
        fabric.Image.fromURL('tablecover-blank.png', (img) => {
            img.scaleToWidth(canvas.getWidth());
            canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
                originX: 'center', originY: 'center', left: canvas.getWidth() / 2, top: canvas.getHeight() / 2,
            });
        }, { crossOrigin: 'anonymous' });
        
        // --- UI EVENT LISTENERS ---

        // UPLOAD IMAGE
        const logoUploadInput = document.getElementById('logo-upload');
        document.getElementById('upload-btn').addEventListener('click', () => logoUploadInput.click());
        logoUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (f) => {
                fabric.Image.fromURL(f.target.result, (logoImg) => {
                    const padding = 0.90;
                    const paddedWidth = targetArea.width * padding;
                    const paddedHeight = targetArea.height * padding;
                    const scale = Math.min(paddedWidth / logoImg.width, paddedHeight / logoImg.height);
                    
                    logoImg.scale(scale);
                    logoImg.set({
                        left: centerH,
                        top: centerV,
                        originX: 'center', originY: 'center',
                        clipPath: clipRect // Apply clipping mask
                    });
                    addDeleteControl(logoImg);
                    canvas.add(logoImg).setActiveObject(logoImg).renderAll();
                });
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        });

        // --- START: Text Modal Logic ---
        const textModal = document.getElementById('text-modal');
        const modalTextInput = document.getElementById('modal-text-input');
        const modalFontFamily = document.getElementById('modal-font-family');
        const modalTextColor = document.getElementById('modal-text-color');
        
        document.getElementById('add-text-btn').addEventListener('click', () => {
            textModal.classList.add('visible');
            modalTextInput.focus();
        });

        function hideTextModal() {
            textModal.classList.remove('visible');
        }
        document.getElementById('modal-cancel-btn').addEventListener('click', hideTextModal);
        textModal.addEventListener('click', (e) => {
            if (e.target === textModal) { hideTextModal(); }
        });

        document.getElementById('modal-confirm-btn').addEventListener('click', () => {
            const textString = modalTextInput.value;
            if (textString) {
                const text = new fabric.IText(textString, {
                    fontFamily: modalFontFamily.value,
                    fill: modalTextColor.value,
                    fontSize: 40,
                    stroke: '#ffffff',
                    strokeWidth: 1,
                    paintFirst: 'stroke',
                    left: centerH,
                    top: centerV,
                    originX: 'center',
                    originY: 'center',
                    clipPath: clipRect // Apply clipping mask
                });
                addDeleteControl(text);
                canvas.add(text).setActiveObject(text).renderAll();
                modalTextInput.value = ''; 
                hideTextModal();
            }
        });

        modalTextInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { document.getElementById('modal-confirm-btn').click(); }
        });
        // --- END: Text Modal Logic ---

        // --- START: CONSOLIDATED COLOR LOGIC ---
        const colorInput = document.getElementById('color-picker');
        const colorSwatch = document.getElementById('color-swatch');
        const colorBtnMain = document.getElementById('color-btn-main');
        const colorBtnDropdown = document.getElementById('color-btn-dropdown');
        const colorDropdownMenu = document.getElementById('color-dropdown-menu');
        const pantoneModal = document.getElementById('pantone-modal');

        function applyTableclothColor(color) {
            colorSwatch.style.backgroundColor = color;
            const bgImage = canvas.backgroundImage;
            if (!bgImage) return;

            bgImage.filters = [];
            if (color.toLowerCase() !== '#ffffff') {
                bgImage.filters.push(new fabric.Image.filters.BlendColor({
                    color: color,
                    mode: 'multiply'
                }));
            }
            bgImage.applyFilters();
            canvas.renderAll();
        }
        
        colorBtnMain.addEventListener('click', () => colorInput.click());
        colorBtnDropdown.addEventListener('click', (e) => {
            e.stopPropagation(); 
            colorDropdownMenu.style.display = colorDropdownMenu.style.display === 'block' ? 'none' : 'block';
        });
        
        document.getElementById('dropdown-item-custom').addEventListener('click', () => {
            colorInput.click();
            colorDropdownMenu.style.display = 'none';
        });
        
        document.getElementById('dropdown-item-pantone').addEventListener('click', () => {
            pantoneModal.classList.add('visible');
            document.getElementById('pantone-search').focus();
            colorDropdownMenu.style.display = 'none';
        });

        colorInput.addEventListener('input', (e) => applyTableclothColor(e.target.value));
        
        window.addEventListener('click', () => {
            if (colorDropdownMenu.style.display === 'block') {
                colorDropdownMenu.style.display = 'none';
            }
        });
        // --- END: CONSOLIDATED COLOR LOGIC ---


        // --- START: PANTONE MODAL LOGIC ---
        const pantoneGrid = document.getElementById('pantone-grid');
        const pantoneSearch = document.getElementById('pantone-search');
        let allPantoneColors = []; 

        async function loadPantoneColors() {
            try {
                const response = await fetch('pantone_colors.json');
                if (!response.ok) throw new Error('Network response was not ok');
                allPantoneColors = await response.json();
                
                let swatchesHTML = '';
                allPantoneColors.forEach(color => {
                    swatchesHTML += `
                        <div class="pantone-card"
                             data-hex="${color.hex}"
                             data-name="${color.name}"
                             title="${color.name} (${color.hex})">
                            <div class="pantone-swatch-bg" style="background-color: ${color.hex};"></div>
                            <div class="pantone-label">${color.name}</div>
                        </div>
                    `;
                });
                pantoneGrid.innerHTML = swatchesHTML;
            } catch (error) {
                console.error('Error loading Pantone colors:', error);
                pantoneGrid.innerHTML = '<p>Error loading colors. Please ensure pantone_colors.json is in the same folder.</p>';
            }
        }
        
        function hidePantoneModal() {
            pantoneModal.classList.remove('visible');
        }
        document.getElementById('pantone-close-btn').addEventListener('click', hidePantoneModal);
        pantoneModal.addEventListener('click', (e) => {
            if (e.target === pantoneModal) { hidePantoneModal(); }
        });

        pantoneGrid.addEventListener('click', (e) => {
            const card = e.target.closest('.pantone-card');
            if (card) {
                applyTableclothColor(card.dataset.hex);
                hidePantoneModal();
            }
        });

        pantoneSearch.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const cards = pantoneGrid.getElementsByClassName('pantone-card');
            
            Array.from(cards).forEach(card => {
                const name = card.dataset.name.toLowerCase();
                card.style.display = name.includes(searchTerm) ? 'block' : 'none';
            });
        });

        loadPantoneColors();
        // --- END: PANTONE MODAL LOGIC ---
        

        // --- START: Contextual Controls Logic (Opacity & Layers) ---
        const contextualControls = document.getElementById('contextual-controls');
        const opacitySlider = document.getElementById('opacity-slider');
        
        function updateControls(e) {
            const activeObj = canvas.getActiveObject();
            if (activeObj && activeObj.type !== 'activeSelection') {
                opacitySlider.value = (activeObj.opacity === undefined ? 1 : activeObj.opacity) * 100;
                contextualControls.classList.add('visible');
            } else {
                contextualControls.classList.remove('visible');
            }
        }

        canvas.on('selection:created', updateControls);
        canvas.on('selection:updated', updateControls);
        canvas.on('selection:cleared', (e) => {
            contextualControls.classList.remove('visible');
            guideLineV.set({ visible: false });
            guideLineH.set({ visible: false });
            canvas.renderAll();
        });

        opacitySlider.addEventListener('input', (e) => {
            const obj = canvas.getActiveObject();
            if (obj) {
                obj.set({ opacity: parseInt(e.target.value) / 100 });
                canvas.renderAll();
            }
        });
        
        document.getElementById('layer-front-btn').addEventListener('click', () => {
            const obj = canvas.getActiveObject();
            if (obj) canvas.bringToFront(obj);
        });
        document.getElementById('layer-forward-btn').addEventListener('click', () => {
            const obj = canvas.getActiveObject();
            if (obj) canvas.bringForward(obj);
        });
        document.getElementById('layer-backward-btn').addEventListener('click', () => {
            const obj = canvas.getActiveObject();
            if (obj) canvas.sendBackwards(obj);
        });
        document.getElementById('layer-back-btn').addEventListener('click', () => {
            const obj = canvas.getActiveObject();
            if (obj) canvas.sendToBack(obj);
        });
        // --- END: Contextual Controls Logic ---


        // DOWNLOAD
        document.getElementById('download-btn').addEventListener('click', () => {
            canvas.discardActiveObject().renderAll();
            guideLineV.set({ visible: false });
            guideLineH.set({ visible: false });
            canvas.renderAll();
            
            const link = document.createElement('a');
            link.download = 'tablecover-mockup.png';
            link.href = canvas.toDataURL({ format: 'png', quality: 1.0 });
            link.click();
        });
        
        // --- NEW: Add to Cart Button Alert ---
        // You can replace this with your real e-commerce logic
        document.getElementById('add-to-cart-btn').addEventListener('click', () => {
            alert('This would add the design to your cart!');
            // --- This is where you would get the JSON and send to server ---
            // const designJSON = JSON.stringify(canvas.toJSON());
            // console.log(designJSON);
        });
    });
    </script>

</body>
</html>
